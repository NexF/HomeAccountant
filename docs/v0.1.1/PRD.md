# 家庭记账 - 产品需求文档 (PRD)

> **版本：v0.1.1**
> **创建日期：2026-02-13**
> **基于版本：v0.0.3**
> **状态：规划中**
> **本版本变更：分录完整编辑（科目、金额、所有业务字段）**

---

## 1. 版本概述

### 1.1 版本目标

v0.1.1 将分录的编辑能力从"仅修改元数据（日期/摘要/备注）"升级为**与新建一致的完整编辑**，用户可以修改分录的科目、金额、以及所有业务字段，同时保留原始分录 ID 不变。

| 变更 | 核心价值 |
|------|---------|
| 分录完整编辑 | 记错科目/金额后无需删除重建，直接编辑修正，保留分录 ID 和创建时间 |
| 复用新建页面 | 编辑时打开 `entry/new.tsx` 页面（预填已有数据），用户体验与新建一致，降低学习成本 |

### 1.2 与 v0.0.3 的关系

- **后端变更**：扩展分录更新 API，支持修改科目、金额、分录行等全部业务字段
- **前端变更**：`entry/new.tsx` 改造为新建/编辑双模式；移除 `entry/[id].tsx` 的内联编辑；桌面端 `EntryDetailPane` 编辑按钮改为跳转新建页面
- **分录 ID 不变**：编辑采用"删旧行+建新行"策略，仅替换 `journal_lines`，`journal_entries` 主记录 ID 保持不变

### 1.3 不包含的内容（留待后续版本）

- 修改 `entry_type`（分录类型不可变更，如不能把"费用"改成"收入"）— 远期版本将提供"转换类型"功能，见 v0.1.0 规划
- 编辑联动实体的变更（编辑分录不会修改已关联的固定资产/贷款记录）
- 家庭账本 & 多人协作
- CSV 账单导入 & 流水匹配对账

### 1.4 设计约束

- **分录 ID 不变**：编辑不改变 `journal_entries.id` 和 `created_at`
- **entry_type 不可变**：编辑时分录类型固定，不允许从"费用"改为"收入"等
- **联动实体不受影响**：若分录关联了固定资产或贷款，编辑分录不会修改/删除这些联动记录
- **借贷平衡校验**：编辑后的分录仍需通过借贷平衡校验

---

## 2. 功能需求：分录完整编辑

### 2.1 当前问题

| 维度 | 当前（v0.0.3） | 目标（v0.1.1） |
|------|---------------|---------------|
| 可编辑字段 | 日期、摘要、备注（3 个元数据字段） | 所有业务字段（科目、金额、日期、摘要、备注等） |
| 编辑入口 | 详情页内联编辑（TextInput 切换） | 跳转到 `entry/new.tsx`（预填数据，编辑模式） |
| 后端 API | `PUT /entries/{id}` 仅支持 3 个字段 | `PUT /entries/{id}` 支持与创建一致的全部字段 |

### 2.2 用户流程

**手机端：**
1. 用户在账本（Ledger）列表中点击某条分录 → 进入 `entry/[id].tsx` 详情页
2. 点击右上角编辑按钮 → 跳转到 `entry/new.tsx?editId={id}`
3. 页面加载时检测到 `editId` 参数 → 请求分录详情 → 预填所有字段（科目、金额、日期、摘要等）
4. 用户修改任意字段后点击"保存" → 调用 `PUT /entries/{id}` 更新
5. 保存成功后返回详情页，数据刷新

**桌面端：**
1. 用户在账本（Ledger）左侧列表中点击分录 → 右侧 `EntryDetailPane` 显示详情
2. 点击编辑按钮 → 跳转到 `entry/new.tsx?editId={id}`（全屏页面，遵循设计规范第 3 节中记账页的例外：记账页本身是全屏路由页面，不在右侧面板内嵌）
3. 编辑完成保存后返回账本页，右侧面板刷新

### 2.3 编辑页面设计

复用 `entry/new.tsx` 页面，通过 URL 参数 `editId` 区分新建/编辑模式：

```
┌─────────────────────────────┐
│  ←  编辑分录        [保存]   │   ← 标题从"记一笔"变为"编辑分录"
├─────────────────────────────┤
│  [费用] [收入] ... (灰色不可切换) │   ← 编辑模式下 entry_type 不可改
├─────────────────────────────┤
│                             │
│  （与新建完全一致的表单）      │
│  科目、金额、日期、摘要...    │   ← 预填已有数据
│                             │
├─────────────────────────────┤
│  ┌─────────────────────────┐│
│  │     0     0     0       ││
│  │     1     2     3       ││   ← 金额键盘预填已有金额
│  │     ...                 ││
│  └─────────────────────────┘│
└─────────────────────────────┘
```

**编辑模式与新建模式的差异：**

| 维度 | 新建模式 | 编辑模式 |
|------|---------|---------|
| 页面标题 | "记一笔" | "编辑分录" |
| entry_type Tab | 可切换 | 灰色锁定，显示当前类型但不可点击 |
| 表单初始值 | 空 | 预填已有分录数据 |
| 保存按钮调用 | `POST /books/{bookId}/entries` | `PUT /entries/{editId}` |
| 保存成功后 | `router.back()` | `router.back()` |
| 折旧/贷款设置区域 | 正常显示 | **隐藏**（编辑不影响联动实体） |

### 2.4 详情页变更

`entry/[id].tsx` 详情页改为**纯只读展示**，移除内联编辑功能（TextInput 切换）：

```
┌─────────────────────────────┐
│  ←  分录详情   [✏️编辑] [🗑️]  │
├─────────────────────────────┤
│  类型         费用            │   ← 全部只读
│  日期         2026-02-13     │
│  摘要         午餐            │
│  备注         -              │
│  来源         manual         │
│  平衡         是             │
├─────────────────────────────┤
│  借贷明细                     │
│  科目     借方     贷方       │
│  餐饮     45.00    -         │
│  银行     -        45.00     │
├─────────────────────────────┤
│  创建时间  2026-02-13 10:30  │
│  更新时间  2026-02-13 14:20  │
└─────────────────────────────┘
```

点击编辑按钮 → `router.push('/entry/new?editId={id}')`

桌面端 `EntryDetailPane`（`ledger.tsx` 内）同步改为纯只读，编辑按钮跳转到 `entry/new.tsx?editId={id}`。

### 2.5 分录数据预填映射

从分录详情 API 返回的数据映射到 `new.tsx` 表单字段：

| 分录详情字段 | 表单字段 | 映射规则 |
|------------|---------|---------|
| `entry_type` | 类型 Tab（锁定） | 直接映射 |
| `entry_date` | 日期 | 直接映射 |
| `description` | 摘要 | 直接映射 |
| `note` | 备注 | 直接映射 |
| `lines[].account_id` | 各科目选择器 | 按借贷方向和科目类型反向推导 |
| `lines[].debit_amount` / `credit_amount` | 金额输入 | 取非零方的金额 |

**科目反向推导规则（按 entry_type）：**

| entry_type | 借方 line → 表单字段 | 贷方 line → 表单字段 |
|-----------|---------------------|---------------------|
| expense | 借方科目 → `categoryAccount` | 贷方科目 → `paymentAccount` |
| income | 借方科目 → `paymentAccount` | 贷方科目 → `categoryAccount` |
| transfer | 借方科目 → `toAccount` | 贷方科目 → `fromAccount` |
| asset_purchase | 借方资产科目 → `assetAccount`；贷方支付科目 → `paymentAccount`；贷方负债科目 → `extraLiabilityAccount` | 按 account_type 区分 |
| borrow | 借方科目 → `paymentAccount` | 贷方科目 → `liabilityAccount` |
| repay | 借方负债科目 → `liabilityAccount`；借方费用科目 → `categoryAccount` | 贷方科目 → `paymentAccount` |

### 2.6 交互细节

| 交互 | 说明 |
|------|------|
| 编辑入口 | 详情页编辑按钮、桌面端详情面板编辑按钮 |
| entry_type 锁定 | 编辑模式下类型 Tab 显示当前类型（高亮），但不可点击切换 |
| 科目预填 | 打开编辑页时，科目选择器显示已选科目名称，可点击重新选择 |
| 金额预填 | 金额输入键盘预填已有金额 |
| 折旧/贷款区域 | 编辑模式下隐藏，避免与已有联动实体冲突 |
| 保存校验 | 与新建一致（必填字段校验、借贷平衡校验） |
| 保存失败 | Toast 提示错误信息 |
| 取消编辑 | 点击返回按钮，不保存 |

---

## 3. API 变更

### 3.1 更新分录 API

**端点**：`PUT /entries/{entry_id}`

**变更前（v0.0.3）**：仅接受 `entry_date`、`description`、`note`

**变更后（v0.1.1）**：接受与创建一致的全部业务字段（除 `entry_type` 外）

| 字段 | 类型 | 说明 |
|------|------|------|
| `entry_date` | `date?` | 分录日期 |
| `description` | `str?` | 描述 |
| `note` | `str?` | 备注 |
| `amount` | `Decimal?` | 主金额 |
| `category_account_id` | `str?` | 费用/收入科目 |
| `payment_account_id` | `str?` | 支付/收款账户 |
| `asset_account_id` | `str?` | 资产科目 |
| `liability_account_id` | `str?` | 负债科目 |
| `principal` | `Decimal?` | 还款本金 |
| `interest` | `Decimal?` | 还款利息 |
| `from_account_id` | `str?` | 转账来源 |
| `to_account_id` | `str?` | 转账目标 |
| `extra_liability_account_id` | `str?` | 额外负债科目 |
| `extra_liability_amount` | `Decimal?` | 额外负债金额 |
| `lines` | `list[JournalLineCreate]?` | 手动分录行（manual 类型） |

> 注意：`entry_type` 不在更新请求中，沿用原分录类型。折旧/贷款联动字段（`asset_name`、`loan_name` 等）不在更新请求中。

### 3.2 获取分录详情 API（无变更）

`GET /entries/{entry_id}` 返回结构不变，已包含完整的 `lines`（含 `account_id`、`account_name`、`debit_amount`、`credit_amount`）。

---

## 4. 版本规划更新

### v0.0.1 (MVP) — 已完成 ✅
- [x] 邮箱注册/登录
- [x] 科目体系
- [x] 快捷记账（6种类型）
- [x] 分录列表（账本）
- [x] 资产负债表 & 损益表
- [x] 总览仪表盘
- [x] 手动对账 & 待处理队列
- [x] 三端适配 & 深色模式

### v0.0.2 — 已完成 ✅
- [x] 固定资产折旧管理（自动折旧分录、资产处置）
- [x] 贷款管理 & 还款计划（还款计划表、本金/利息自动拆分、提前还款）
- [x] 预算管理 & 提醒（总预算/分类预算、超支提醒、Dashboard 联动）

### v0.0.3 — 已完成 ✅
- [x] 总览页桌面端布局重构（左右分栏，近期分录移至右侧面板）
- [x] 移动端 Dashboard 移除近期分录区块

### v0.1.1 — 本版本
- [ ] 分录完整编辑（科目、金额、所有业务字段）
- [ ] 复用 `entry/new.tsx` 作为编辑页面（预填数据，编辑模式）
- [ ] 后端 `PUT /entries/{id}` 扩展为支持全部业务字段
- [ ] 详情页改为纯只读，编辑跳转到编辑页面

### v0.2.0（远期）
- [ ] 银行 Open Banking API 对接
- [ ] 券商/基金 API 对接
- [ ] 智能流水分类（AI 建议）
- [ ] 离线记账 + 本地 SQLite 缓存
- [ ] **分录类型转换**：提供"转换类型"操作，允许将已有分录转换为其他 `entry_type`（如银行账单自动同步时统一记为"费用"，后续发现实际是固定资产购置，可转换为"资产购置"类型）。实现策略为后端自动"删旧建新"，但保留原分录的来源信息（`source`、`description`、`entry_date`）并在新分录 `note` 中记录转换来源，供审计追溯

### （远期）
- [ ] 家庭账本 & 多人协作
- [ ] CSV 账单导入 & 流水匹配对账
- [ ] 高级模式（手动分录）
- [ ] 数据导出（CSV/Excel/PDF）