# 家庭记账 - 产品需求文档 (PRD)

> **版本：v0.2.3**
> **创建日期：2026-02-14**
> **基于版本：v0.2.2**
> **状态：规划中**
> **本版本变更：前端科目新增/管理完整闭环**

---

## 1. 版本概述

### 1.1 版本目标

v0.2.2 完成了「末级科目记账约束」的后端逻辑和 AccountPicker 改造，但**前端缺少科目新增入口**——用户无法在 App 内创建自定义科目或为现有科目新增子科目。本版本补齐这一关键缺失，实现科目管理的完整 CRUD 闭环。

| 能力 | 核心价值 |
|------|---------|
| 科目行内 "+" 按钮 | 每个科目右侧显示 "+" 按钮，点击即以该科目为父创建子科目，零认知成本 |
| Header "+" 顶级科目 | 列表页 Header 保留 "+" 按钮，用于创建当前 Tab 类型下的顶级科目 |
| 科目详情页新增子科目 | 科目详情页子科目 section 也提供 "+" 入口，保持一致性 |
| 新增科目表单 | 统一的科目创建 Modal（编码、名称、余额方向、图标），父科目/类型自动锁定 |
| 迁移结果通知 | 创建子科目触发自动迁移后，前端展示迁移条数和目标科目信息 |
| 桌面端同步适配 | AccountsPane 桌面端与移动端保持功能一致 |

### 1.2 问题背景

当前前端科目管理模块的功能矩阵：

| 操作 | 后端 API | 移动端 UI | 桌面端 UI |
|------|---------|----------|----------|
| 查看科目树 | ✅ `GET /books/{id}/accounts` | ✅ | ✅ |
| 查看科目详情 | ✅（从树中取） | ✅ `accounts/[id].tsx` | ✅ `AccountDetailInline` |
| 编辑科目 | ✅ `PUT /accounts/{id}` | ✅ | ✅ |
| 停用科目 | ✅ `DELETE /accounts/{id}` | ✅ | ✅ |
| **新增科目** | ✅ `POST /books/{id}/accounts` | ❌ 无入口 | ❌ 无入口 |
| **新增子科目** | ✅（同上，传 `parent_id`） | ❌ 无入口 | ❌ 无入口 |

后端 API 和前端 `accountService.createAccount()` 均已就绪，唯独缺少 UI 入口。

### 1.3 设计决策

| 决策项 | 选择 | 理由 |
|--------|------|------|
| 子科目新增入口 | **每个科目行右侧 "+" 按钮** | 点击即确定父科目，零认知成本，不需要手动选父科目 |
| 顶级科目新增入口 | Header 右侧 "+" 按钮 | 创建当前 Tab 类型下的顶级科目（无父科目） |
| 表单形式 | Modal 弹窗 | 与现有停用确认弹窗风格一致，不跳转页面 |
| 子科目表单预填 | 类型 + 方向 + 父科目自动锁定 | 点击行内 "+" 时上下文已确定，用户只需填编码和名称 |
| 迁移提示 | Toast / Alert | 创建子科目触发迁移后立即展示，告知用户影响 |

### 1.4 不包含的内容（留待后续版本）

- 科目批量导入（CSV/Excel）
- 科目合并/拆分
- 科目排序拖拽
- 科目模板（从预设模板快速创建一组科目）

---

## 2. 功能需求：科目行内 "+" 按钮（新增子科目）

这是本版本最核心的功能入口。

### 2.1 设计理念

用户想给「餐饮饮食」加一个「外卖」子科目时，最自然的操作是：**在「餐饮饮食」那一行点 "+"**。不需要先进入详情页，不需要手动选父科目——点击位置本身就确定了父科目。

### 2.2 科目列表 UI 布局

每个科目行（`AccountRow`）右侧新增一个 "+" 按钮。科目列表只保留 "+" 按钮，**不显示删除/停用按钮**（停用操作移至科目详情页底部，见第 3 节）：

```
┌──────────────────────────────────────────────────┐
│  ←    科目管理                            [＋]   │ ← Header "+"：创建顶级科目
├──────────────────────────────────────────────────┤
│  资产 │ 负债 │ 权益 │ 收入 │ 费用               │
├──────────────────────────────────────────────────┤
│  🏦 货币资金   1001   借          [＋]           │ ← 行内 "+"：以 1001 为父
│    💵 现金     1001-01 借          [＋]           │ ← 行内 "+"：以 1001-01 为父
│    🏛 存款     1001-02 借          [＋]           │
│      工商银行  1001-0201 借        [＋]           │
│      招商银行  1001-0202 借        [＋]           │
│  📈 现金等价物 1002     借         [＋]           │
│  ...                                             │
└──────────────────────────────────────────────────┘
```

#### 2.2.1 按钮显示规则

| 条件 | "+" 按钮 |
|------|---------|
| 任意科目 | ✅ 始终显示 |

所有科目（无论是叶子还是父节点）都显示 "+" 按钮，因为任意科目都可以成为父科目。

> **停用/删除** 操作从科目列表行中移除，改为在科目详情页底部展示「停用科目」按钮（破坏性操作不宜放在列表行内，避免误触）。

### 2.3 交互流程

```
用户在科目列表中看到「5001 餐饮饮食」行右侧的 [＋] 按钮
  ↓
点击 [＋]
  ↓
弹出「新增子科目」Modal，表单自动预填：
  - 父科目：「5001 餐饮饮食」（只读标签，不可修改）
  - 类型：expense（继承父科目，锁定）
  - 余额方向：debit（继承父科目，锁定）
  - 编码：预填 "5001-"（用户只需补全后缀，如输入 "01"）
  - 名称：空（用户填写，如 "外卖"）
  - 图标：空（可选）
  ↓
用户填写编码后缀 "01" + 名称 "外卖"
  ↓
点击「创建」
  ↓
调用 accountService.createAccount(bookId, {
  code: "5001-01", name: "外卖", type: "expense",
  balance_direction: "debit", parent_id: "5001的UUID"
})
  ↓
成功 → 关闭 Modal + 刷新科目树
       如果 migration.triggered → 展示迁移提示
失败 → 展示错误信息
```

### 2.4 Header "+" 按钮（创建顶级科目）

Header 右侧保留一个 "+" 按钮，用于创建**当前 Tab 类型下的顶级科目**（无父科目）。

```
用户点击 Header [＋]
  ↓
弹出「新增科目」Modal，表单预填：
  - 父科目：无（顶级科目）
  - 类型：当前 Tab 类型（锁定）
  - 余额方向：根据类型自动设定（可手动调整）
  - 编码：空
  - 名称：空
```

### 2.5 移动端 vs 桌面端

| 页面 | 行为 |
|------|------|
| 移动端 `accounts/index.tsx` | `AccountRow` 新增 `onAdd` 回调 + Header "+" |
| 桌面端 `AccountsPane.tsx` | `AccountRow` 新增 `onAdd` 回调 + 标题栏 "+" |

桌面端和移动端统一使用 `showToast` 提示（遵循 `DESIGN_GUIDELINES.md` 第 1 节）。

---

## 3. 功能需求：科目详情页新增子科目

### 3.1 入口位置

在科目详情页的「子科目」section 标题栏右侧也提供 "+" 按钮，作为行内 "+" 的补充入口。

#### 有子科目时

```
┌─────────────────────────────────────┐
│  子科目（2）                  [＋]  │
├─────────────────────────────────────┤
│  ○ 现金              1001-01    >  │
│  ○ 存款              1001-02    >  │
└─────────────────────────────────────┘
```

#### 无子科目时（始终显示该 section）

```
┌─────────────────────────────────────┐
│  新增子科目                   [＋]  │
├─────────────────────────────────────┤
│     点击右侧 ＋ 添加子科目         │
└─────────────────────────────────────┘
```

### 3.2 交互流程

与列表页行内 "+" 完全一致：以当前科目为父，类型/方向/父科目锁定，编码预填 `{父编码}-`。

### 3.3 停用科目按钮（从列表移至详情页）

本版本将停用科目操作从科目列表行中移除，改为在科目详情页**底部**显示：

```
┌─────────────────────────────────────┐
│  ←  1001 货币资金                   │
├─────────────────────────────────────┤
│  编码：1001                         │
│  名称：货币资金                      │
│  类型：资产                          │
│  余额方向：借方                      │
│  ...                                │
├─────────────────────────────────────┤
│  子科目（2）                  [＋]  │
│  ○ 现金              1001-01    >  │
│  ○ 存款              1001-02    >  │
├─────────────────────────────────────┤
│                                     │
│          [  停用科目  ]             │ ← 红色危险按钮，页面最底部
│                                     │
└─────────────────────────────────────┘
```

- 停用按钮使用红色/危险色样式，明确破坏性操作
- 点击后弹出确认 Modal（与现有逻辑一致）
- 系统科目不显示停用按钮

### 3.4 适用页面

| 页面 | 组件 |
|------|------|
| 移动端 | `accounts/[id].tsx` |
| 桌面端 | `AccountDetailInline`（在 `AccountsPane.tsx` 中） |

---

## 4. 功能需求：新增科目表单

### 4.1 两种模式

表单分为两种模式，由触发入口决定：

| 模式 | 触发入口 | 特点 |
|------|---------|------|
| 子科目模式 | 科目行内 "+" / 详情页子科目 "+" | 父科目、类型、方向全部锁定，用户只需填编码后缀和名称 |
| 顶级科目模式 | Header "+" | 无父科目，类型锁定为当前 Tab，方向可调 |

### 4.2 子科目模式表单字段

| 字段 | 类型 | 状态 | 默认值 | 说明 |
|------|------|------|--------|------|
| 父科目 | 只读标签 | 🔒 锁定 | 触发行的科目 | 显示「科目名 (编码)」 |
| 类型 | 只读标签 | 🔒 锁定 | 继承父科目 | 不可修改 |
| 余额方向 | 只读标签 | 🔒 锁定 | 继承父科目 | 不可修改 |
| 编码 | TextInput | ✏️ 可编辑 | `{父编码}-` | 预填前缀，用户补全后缀 |
| 名称 | TextInput | ✏️ 可编辑 | 空 | 必填 |
| 图标 | TextInput | ✏️ 可编辑 | 空 | 可选，FontAwesome 图标名 |

子科目模式下表单非常简洁，用户只需要关注两个字段：**编码后缀**和**名称**。

### 4.3 顶级科目模式表单字段

| 字段 | 类型 | 状态 | 默认值 | 说明 |
|------|------|------|--------|------|
| 类型 | 只读标签 | 🔒 锁定 | 当前 Tab 类型 | 不可修改（由 Tab 决定） |
| 余额方向 | 单选 Chip | ✏️ 可调 | 根据类型自动设定 | 借方/贷方 |
| 编码 | TextInput | ✏️ 可编辑 | 空 | 必填 |
| 名称 | TextInput | ✏️ 可编辑 | 空 | 必填 |
| 图标 | TextInput | ✏️ 可编辑 | 空 | 可选 |

### 4.4 字段联动规则

| 触发 | 效果 |
|------|------|
| 顶级科目模式，类型为 asset / expense | 余额方向默认 `debit` |
| 顶级科目模式，类型为 liability / income / equity | 余额方向默认 `credit` |

### 4.5 表单校验

| 校验项 | 规则 | 提示 |
|--------|------|------|
| 编码为空 | 前端禁用「创建」按钮 | - |
| 名称为空 | 前端禁用「创建」按钮 | - |
| 编码重复 | 后端返回 400 | `编码 {code} 已存在` |
| 父科目类型不匹配 | 后端返回 400 | `子科目类型必须与父科目一致` |

---

## 5. 功能需求：迁移结果通知

### 5.1 触发条件

当 `createAccount` API 响应中 `migration.triggered === true` 时触发。

### 5.2 展示方式

遵循 `DESIGN_GUIDELINES.md` 第 1 节 — 提示反馈规范，**统一使用 `showToast`**，不使用 `window.alert` 或 `Alert.alert`：

```typescript
// 标准写法（所有平台统一）
if (data.migration?.triggered) {
  showToast('分录已迁移', data.migration.message, 5000);
  // 迁移消息较长，Toast 超时延长至 5 秒
}
```

展示内容示例：

```
分录已迁移：已将 15 条分录从「餐饮饮食」迁移至「待分类餐饮饮食」
```

移动端和桌面端行为一致：页面顶部 Toast 提示条，5 秒自动消失。

---

## 6. UI 设计规范

### 6.1 行内 "+" 按钮样式

| 属性 | 值 |
|------|-----|
| 图标 | FontAwesome `plus` |
| 大小 | 13px |
| 颜色 | `Colors.primary` |
| 触摸区域 | 32x32 |
| 位置 | 科目行右侧 |

### 6.2 Header "+" 按钮样式

| 属性 | 值 |
|------|-----|
| 图标 | FontAwesome `plus` |
| 大小 | 18px |
| 颜色 | `Colors.primary` |
| 触摸区域 | 36x36 |
| 位置 | Header 右侧 |

### 6.2 Modal 弹窗样式

| 属性 | 值 |
|------|-----|
| 宽度 | 90%，最大 420px |
| 圆角 | 14px |
| 内边距 | 20px |
| 最大高度 | 85% 屏幕高度 |
| 背景遮罩 | rgba(0,0,0,0.4) |
| 动画 | `slide`（移动端）/ `fade`（桌面端） |

### 6.3 Chip 选择器样式

| 属性 | 值 |
|------|-----|
| 圆角 | 14px |
| 水平内边距 | 12px |
| 垂直内边距 | 5px |
| 选中边框色 | 对应类型颜色 / Colors.primary |
| 选中背景色 | 对应颜色 + 20% 透明度 |
| 字体 | 13px，fontWeight 500 |

### 6.4 表单输入框样式

| 属性 | 值 |
|------|-----|
| 字体 | 15px |
| 内边距 | 垂直 8px，水平 10px |
| 边框 | 1px，borderRadius 8px |
| 边框颜色 | `colors.border` |

---

## 7. 涉及文件变更

### 7.1 移动端

| 文件 | 变更内容 |
|------|---------|
| `client/app/accounts/index.tsx` | `AccountRow` 移除停用按钮 + 新增 `onAdd` 回调 + 行内 "+" 按钮 + Header "+" 按钮 + 新增科目 Modal + handleCreate |
| `client/app/accounts/[id].tsx` | 子科目 section 添加 "+" 按钮 + 新增子科目 Modal + handleCreateChild + 页面底部添加「停用科目」按钮 |

### 7.2 桌面端

| 文件 | 变更内容 |
|------|---------|
| `client/features/account/AccountsPane.tsx` | `AccountRow` 移除停用按钮 + 新增 `onAdd` 回调 + 行内 "+" 按钮 + 标题栏 "+" 按钮 + 新增科目 Modal + handleCreate |
| `client/features/account/AccountsPane.tsx` > `AccountDetailInline` | 子科目 section 添加 "+" 按钮 + 新增子科目 Modal + handleCreateChild + 底部添加「停用科目」按钮 |

### 7.3 无需变更

| 文件 | 说明 |
|------|------|
| `client/services/accountService.ts` | 已有 `createAccount` 方法和完整类型定义 |
| `server/**` | 后端 API 已完整实现，无需改动 |

---

## 8. 版本规划更新

### v0.0.1 (MVP) — 已完成 ✅
### v0.0.2 — 已完成 ✅
### v0.0.3 — 已完成 ✅
### v0.1.1 — 已完成 ✅
### v0.2.0 — 已完成 ✅
### v0.2.1 — 已完成 ✅
### v0.2.2 — 已完成 ✅

### v0.2.3 — 本版本

- [ ] 科目行内 "+" 按钮（新增子科目）
  - [ ] 移动端 `AccountRow` 移除停用按钮 + 新增 `onAdd` 回调 + "+" 按钮
  - [ ] 桌面端 `AccountRow` 移除停用按钮 + 新增 `onAdd` 回调 + "+" 按钮
  - [ ] 点击弹出子科目模式 Modal（父科目/类型/方向锁定，编码预填前缀）
- [ ] Header "+" 按钮（新增顶级科目）
  - [ ] 移动端 Header 右侧 "+"
  - [ ] 桌面端标题栏 "+"
  - [ ] 点击弹出顶级科目模式 Modal（类型锁定为当前 Tab）
- [ ] 新增科目表单
  - [ ] 编码 + 名称输入框
  - [ ] 子科目模式：父科目/类型/方向只读标签
  - [ ] 顶级科目模式：余额方向 Chip 选择器
  - [ ] 图标输入（可选）
  - [ ] 创建按钮（编码和名称为空时禁用）
- [ ] 科目详情页新增子科目
  - [ ] 移动端 `accounts/[id].tsx` 子科目 section "+" 按钮
  - [ ] 桌面端 `AccountDetailInline` 子科目 section "+" 按钮
  - [ ] 无子科目时显示引导提示
- [ ] 停用按钮移至详情页
  - [ ] 科目列表行移除停用/删除按钮
  - [ ] 科目详情页底部添加「停用科目」红色按钮（非系统科目才显示）
  - [ ] 点击弹出确认 Modal
- [ ] 迁移结果通知
  - [ ] 创建子科目触发迁移后展示 Alert / Toast
  - [ ] 展示迁移条数和目标科目信息
- [ ] 错误处理
  - [ ] 编码冲突提示
  - [ ] 网络错误提示
  - [ ] 后端业务错误友好展示
- [ ] 验证
  - [ ] 行内 "+" 创建子科目 → 成功 → 科目树刷新
  - [ ] Header "+" 创建顶级科目 → 成功 → 科目树刷新
  - [ ] 详情页 "+" 创建子科目 → 成功 → 详情页刷新
  - [ ] 创建子科目触发迁移 → 展示迁移提示
  - [ ] 编码重复 → 展示错误信息
  - [ ] 桌面端与移动端行为一致
  - [ ] 科目列表行无停用按钮 → 详情页底部有「停用科目」按钮 → 点击弹确认 Modal

### （远期）

- [ ] 科目批量导入（CSV/Excel）
- [ ] 科目合并/拆分
- [ ] 科目排序拖拽
- [ ] 分录类型转换功能完善
- [ ] 家庭账本 & 多人协作
- [ ] CSV 账单导入 & 流水匹配对账
- [ ] 数据导出（CSV/Excel/PDF）

---

## 9. 验收标准

| 编号 | 验收项 | 验收标准 |
|------|--------|---------|
| C-1 | 行内 "+" 按钮 | 科目列表中每个科目行右侧仅有 "+" 按钮（无停用/删除按钮） |
| C-2 | 行内 "+" 弹窗 | 点击行内 "+" → 弹出子科目模式 Modal，父科目/类型/方向自动锁定 |
| C-3 | 编码预填 | 子科目模式编码预填 `{父编码}-`，用户只需补全后缀 |
| C-4 | Header "+" 按钮 | 科目管理页 Header 有 "+" 按钮 |
| C-5 | Header "+" 弹窗 | 点击 Header "+" → 弹出顶级科目模式 Modal，类型锁定为当前 Tab |
| C-6 | 创建子科目 | 行内 "+" 填写编码名称 → 创建成功 → 子科目出现在父科目下 |
| C-7 | 创建顶级科目 | Header "+" 填写编码名称 → 创建成功 → 科目树出现新顶级科目 |
| C-8 | 详情页 "+" | 科目详情页子科目 section 有 "+" 按钮，行为与行内 "+" 一致 |
| C-9 | 无子科目引导 | 科目详情页无子科目时显示引导提示 + "+" 入口 |
| C-10 | 迁移提示 | 给有分录的叶子科目创建首个子科目 → 展示迁移提示（条数 + 目标科目） |
| C-11 | 编码冲突错误 | 输入已存在的编码 → 展示后端错误信息 |
| C-12 | 创建按钮禁用 | 编码或名称为空时「创建」按钮灰色且不可点击 |
| C-13 | 桌面端一致性 | AccountsPane 的 AccountRow 行内 "+" 和 AccountDetailInline 的子科目 "+" 与移动端行为一致 |
| C-14 | 科目树刷新 | 创建成功后科目树自动刷新，新科目立即可见 |
| C-15 | 停用按钮位置 | 科目详情页底部显示「停用科目」红色按钮（非系统科目），点击弹出确认 Modal |
| C-16 | 列表无停用按钮 | 科目列表行中不再显示停用/删除按钮 |

---

## 10. 约束与风险

| 约束/风险 | 说明 | 缓解措施 |
|----------|------|---------|
| 行内按钮简洁 | 科目行右侧只有 "+" 按钮，停用操作移至详情页底部 | 列表保持简洁，破坏性操作需进入详情页确认，避免误触 |
| 编码命名规范 | 用户可能输入不规范的编码 | 子科目模式预填前缀降低出错概率，编码格式由后端统一校验 |
| 迁移操作不可撤销 | 创建子科目触发的迁移无法回退 | API 响应中明确告知迁移结果，用户可后续逐条调整 |
| 小屏设备表单 | Modal 内容在小屏可能需要滚动 | 子科目模式字段很少（仅编码+名称+图标），几乎不需滚动 |
